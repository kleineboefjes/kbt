{% comment %}
  Kleine Boefies – Product met diavoorstelling + nette info
  Volledige vervanging van sections/main-product.liquid
{% endcomment %}

{{ 'component-price.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .kb-product{padding:clamp(16px,3vw,32px) 0}
  .kb-grid{display:grid;grid-template-columns:1fr;gap:28px}
  @media(min-width: 990px){.kb-grid{grid-template-columns:1.2fr .8fr}}

  /* === Slider === */
  .kb-slider{position:relative;border-radius:14px;overflow:hidden;background:#fff}
  .kb-slide{display:none}
  .kb-slide.is-active{display:block}
  .kb-slide img{width:100%;height:auto;display:block}
  .kb-arrow{
    position:absolute;top:50%;transform:translateY(-50%);
    width:38px;height:38px;border-radius:50%;border:0;cursor:pointer;
    background:#ffffffcc;backdrop-filter:saturate(140%) blur(2px);
    display:flex;align-items:center;justify-content:center;
  }
  .kb-arrow:hover{background:#fff}
  .kb-arrow--prev{left:10px}
  .kb-arrow--next{right:10px}

  .kb-thumbs{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
  .kb-thumb{border-radius:10px;overflow:hidden;cursor:pointer;border:2px solid transparent}
  .kb-thumb.is-active{border-color:#6CB4B8}
  .kb-thumb img{width:100%;height:auto;display:block}

  /* === Info kolom === */
  .kb-title{margin:0 0 6px;font-weight:800;color:#3D2F2F}
  .kb-vendor{margin:0 0 10px;color:#8b7f7f;font-size:.9rem;letter-spacing:.02em}
  .kb-brief{color:#4c3f3f;line-height:1.55;margin:10px 0 14px}
  .kb-price{display:flex;gap:10px;align-items:center;margin:.25rem 0 1rem}
  .kb-chip{display:inline-block;background:#FFF0F4;color:#F2A65A;font-weight:700;border-radius:999px;padding:.35rem .7rem;line-height:1}
  .kb-price .compare{opacity:.6;text-decoration:line-through}

  .kb-form .row{margin-bottom:14px}
  .kb-form select,.kb-form input[type="number"]{
    width:100%;max-width:280px;padding:10px 12px;border:1px solid #e6ded5;border-radius:12px;background:#fff
  }
  .kb-btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:0;border-radius:999px;
    padding:14px 18px;font-weight:700;color:#fff;background:linear-gradient(135deg,#F4B8C6,#B8DDE6);
    cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.08)
  }
  .kb-btn[disabled]{opacity:.5;cursor:not-allowed}

  .kb-desc{margin-top:28px}
  .kb-note{margin-top:8px;color:#8b7f7f;font-size:.9rem}
  .kb-link{color:#6CB4B8;text-decoration:none;font-weight:700}
  .kb-link:hover{text-decoration:underline}
{%- endstyle -%}

<section class="kb-product">
  <div class="page-width">
    <div class="kb-grid">

      {%- comment -%} MEDIA KOLOM (slider) {%- endcomment -%}
      <div>
        {%- assign images = product.images | default: empty -%}
        {%- assign first_image = product.featured_image | default: product.images.first -%}

        <div class="kb-slider" id="kb-slider-{{ section.id }}" data-index="0">
          {%- if images.size > 0 -%}
            {%- for img in images -%}
              {%- assign alt = img.alt | default: product.title | escape -%}
              <div class="kb-slide{% if forloop.first %} is-active{% endif %}">
                {% if forloop.first %}
                  {{ img | image_url: width: 1600 | image_tag: alt: alt, loading: 'eager', fetchpriority: 'high' }}
                {% else %}
                  {{ img | image_url: width: 1600 | image_tag: alt: alt, loading: 'lazy' }}
                {% endif %}
              </div>
            {%- endfor -%}
          {%- else -%}
            <div class="kb-slide is-active">
              {{ first_image | image_url: width: 1600 | image_tag: alt: product.title | escape }}
            </div>
          {%- endif -%}

          {% if images.size > 1 %}
            <button class="kb-arrow kb-arrow--prev" type="button" aria-label="Vorige">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="kb-arrow kb-arrow--next" type="button" aria-label="Volgende">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          {% endif %}
        </div>

        {% if images.size > 1 %}
          <div class="kb-thumbs" id="kb-thumbs-{{ section.id }}">
            {%- for img in images -%}
              {%- assign alt = img.alt | default: product.title | escape -%}
              <button class="kb-thumb{% if forloop.first %} is-active{% endif %}" type="button" data-i="{{ forloop.index0 }}" aria-label="Toon afbeelding {{ forloop.index }}">
                {{ img | image_url: width: 300 | image_tag: alt: alt, loading: 'lazy' }}
              </button>
            {%- endfor -%}
          </div>
        {% endif %}
      </div>

      {%- comment -%} INFO KOLOM {%- endcomment -%}
      <div>
        {%- if settings.show_vendor and product.vendor != blank -%}
          <p class="kb-vendor">{{ product.vendor }}</p>
        {%- endif -%}
        <h1 class="kb-title">{{ product.title | escape }}</h1>

        {%- comment -%} KORTE BESCHRIJVING TUSSEN TITEL EN KNOP {%- endcomment -%}
        {%- assign _desc_len = product.description | strip_html | size -%}
        {%- if _desc_len > 0 -%}
          <div class="kb-brief">
            {{ product.description | strip_html | truncatewords: 40 }}
            <a class="kb-link" href="#kb-full-desc">Lees meer</a>
          </div>
        {%- endif -%}

        {%- assign cur = product.selected_or_first_available_variant -%}
        <div class="kb-price">
          <span class="kb-chip">{{ cur.price | money }}</span>
          {%- if cur.compare_at_price > cur.price -%}
            <span class="compare">{{ cur.compare_at_price | money }}</span>
          {%- endif -%}
        </div>

        {% capture form_id %}product-form-{{ section.id }}{% endcapture %}
        {%- form 'product', product, id: form_id, novalidate: 'novalidate' -%}
          <div class="kb-form">
            {%- if product.has_only_default_variant -%}
              <input type="hidden" name="id" value="{{ cur.id }}">
            {%- else -%}
              <div class="row">
                <label for="VariantSelector-{{ section.id }}">{{ 'products.product.choose_options' | t }}</label>
                <select id="VariantSelector-{{ section.id }}" name="id">
                  {%- for v in product.variants -%}
                    <option value="{{ v.id }}" {% if v.id == cur.id %}selected{% endif %} {% unless v.available %}disabled{% endunless %}>
                      {{- v.title -}}{% unless v.available %} — {{ 'products.product.sold_out' | t }}{% endunless %}
                    </option>
                  {%- endfor -%}
                </select>
              </div>
            {%- endif -%}

            <div class="row">
              <label for="Quantity-{{ section.id }}">{{ 'products.product.quantity.label' | t }}</label>
              <input id="Quantity-{{ section.id }}" class="quantity__input" type="number" name="quantity" min="1" value="1" inputmode="numeric" pattern="[0-9]*">
            </div>

            <div class="row">
              <button type="submit" name="add" class="kb-btn" {% unless cur.available %}disabled{% endunless %}>
                {%- if cur.available -%}
                  {{ 'products.product.add_to_cart' | t }}
                {%- else -%}
                  {{ 'products.product.sold_out' | t }}
                {%- endif -%}
              </button>
            </div>

            {%- if shop.shipping_policy.body != blank -%}
              <p class="kb-note">{{ shop.shipping_policy.body | strip_html }}</p>
            {%- endif -%}
          </div>
        {%- endform -%}
      </div>
    </div>

    {%- if product.description != blank -%}
      <div class="kb-desc rte" id="kb-full-desc">
        {{ product.description }}
      </div>
    {%- endif -%}
  </div>
</section>

{%- javascript -%}
  (function(){
    var slider = document.getElementById('kb-slider-{{ section.id }}');
    if(!slider) return;
    var slides = slider.querySelectorAll('.kb-slide');
    var thumbsWrap = document.getElementById('kb-thumbs-{{ section.id }}');
    var thumbs = thumbsWrap ? thumbsWrap.querySelectorAll('.kb-thumb') : [];
    var i = 0;

    function show(n){
      i = (n + slides.length) % slides.length;
      slides.forEach((s,idx)=>s.classList.toggle('is-active', idx===i));
      if(thumbs.length){
        thumbs.forEach((t,idx)=>t.classList.toggle('is-active', idx===i));
      }
    }
    var prev = slider.querySelector('.kb-arrow--prev');
    var next = slider.querySelector('.kb-arrow--next');
    if(prev) prev.addEventListener('click', function(){ show(i-1); });
    if(next) next.addEventListener('click', function(){ show(i+1); });
    if(thumbs.length){
      thumbs.forEach(function(t){ t.addEventListener('click', function(){ show(parseInt(t.getAttribute('data-i'),10)); }); });
    }
  })();
{%- endjavascript -%}

{% schema %}
{
  "name": "Product (KB met slider)",
  "settings": [],
  "presets": [
    { "name": "Product (KB met slider)" }
  ]
}
{% endschema %}
<style>
  /* zekere weergave: 1 slide tegelijk + actieve thumb */
  #kb-slider-{{ section.id }} .kb-slide{display:none}
  #kb-slider-{{ section.id }} .kb-slide.is-active{display:block}
  #kb-thumbs-{{ section.id }} .kb-thumb.is-active{outline:2px solid #6CB4B8;border-radius:10px}
</style>

<script>
(function(){
  function initKB(){
    var slider = document.getElementById('kb-slider-{{ section.id }}');
    if (!slider) return;

    // voorkom dubbele initialisatie bij section reloads
    if (slider.__kbInited) return;
    slider.__kbInited = true;

    var slides = slider.querySelectorAll('.kb-slide');
    var thumbsWrap = document.getElementById('kb-thumbs-{{ section.id }}');
    var thumbs = thumbsWrap ? thumbsWrap.querySelectorAll('.kb-thumb') : [];
    var prev = slider.querySelector('.kb-arrow--prev');
    var next = slider.querySelector('.kb-arrow--next');
    var i = 0;

    function show(n){
      if (!slides.length) return;
      i = (n + slides.length) % slides.length;
      for (var s=0; s<slides.length; s++){
        slides[s].classList.toggle('is-active', s === i);
      }
      if (thumbs.length){
        for (var t=0; t<thumbs.length; t++){
          thumbs[t].classList.toggle('is-active', t === i);
        }
      }
    }

    if (prev) prev.addEventListener('click', function(e){ e.preventDefault(); show(i - 1); });
    if (next) next.addEventListener('click', function(e){ e.preventDefault(); show(i + 1); });

    if (thumbs.length){
      for (var t=0; t<thumbs.length; t++){
        (function(idx){
          thumbs[idx].addEventListener('click', function(e){
            e.preventDefault();
            show(idx);
          });
        })(t);
      }
    }

    // eenvoudige swipe support
    var startX = 0;
    slider.addEventListener('touchstart', function(ev){ startX = ev.touches[0].clientX; }, {passive:true});
    slider.addEventListener('touchend', function(ev){
      var dx = ev.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 30){ dx < 0 ? show(i + 1) : show(i - 1); }
    });

    // keyboard pijlen
    slider.setAttribute('tabindex', '0');
    slider.addEventListener('keydown', function(ev){
      if (ev.key === 'ArrowLeft') show(i - 1);
      if (ev.key === 'ArrowRight') show(i + 1);
    });

    show(i);
  }

  // init op normale pagina-load
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initKB);
  } else {
    initKB();
  }

  // en opnieuw bij Theme Editor section reload/select
  document.addEventListener('shopify:section:load', function(e){
    if (e.target && e.target.querySelector('#kb-slider-{{ section.id }}')) initKB();
  });
  document.addEventListener('shopify:section:select', function(e){
    if (e.target && e.target.querySelector('#kb-slider-{{ section.id }}')) initKB();
  });
})();
</script>
